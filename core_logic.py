import os
import streamlit as st
from openai import OpenAI
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

def get_config_value(key):
    if hasattr(st, "secrets") and key in st.secrets:
        return st.secrets[key]
    return os.getenv(key, "")

ARK_API_KEY = get_config_value("ARK_API_KEY")
ARK_MODEL_ENDPOINT = get_config_value("ARK_MODEL_ENDPOINT") 
ARK_API_URL = "https://ark.cn-beijing.volces.com/api/v3"

def call_deepseek_api(prompt):
    if not ARK_API_KEY or not ARK_MODEL_ENDPOINT:
        return "âŒ é”™è¯¯: æœªé…ç½® API Key æˆ– Endpoint IDã€‚"

    try:
        client = OpenAI(base_url=ARK_API_URL, api_key=ARK_API_KEY)
        
        completion = client.chat.completions.create(
            model=ARK_MODEL_ENDPOINT,
            messages=[{"role": "user", "content": prompt}],
            # æé«˜ temperature å¯ä»¥è®© AI æ›´æ•¢è¯´ï¼Œæ›´æœ‰åˆ›é€ åŠ›
            temperature=0.6, 
            max_tokens=4000
        )
        return completion.choices[0].message.content
    except Exception as e:
        return f"APIè°ƒç”¨å¤±è´¥: {str(e)}"

def generate_analysis_prompt(stock_code, stock_name, predict_cycle, daily_data, fundamental_data, market_data, style="ç¨³å¥ç†æ™º"):
    """
    æ ¹æ® style ç”Ÿæˆä¸åŒé£æ ¼çš„ Prompt
    """
    
    # æ•°æ®æ ¼å¼åŒ–
    def fmt(d): return {k: str(v) for k, v in d.items()}
    daily = fmt(daily_data)
    fund = fmt(fundamental_data)
    mkt = fmt(market_data)
    
    base_info = f"""
    ## ğŸ“Š æ ‡çš„æ•°æ®
    - **è‚¡ç¥¨**ï¼š{stock_name} ({stock_code})
    - **å‘¨æœŸ**ï¼š{predict_cycle}
    - **æ”¶ç›˜**ï¼š{daily.get('æ”¶ç›˜ä»·')} (æ¶¨è·Œ {daily.get('æ¶¨è·Œå¹…')})
    - **å‡çº¿**ï¼šMA5 {daily.get('5æ—¥å‡çº¿')}, MA20 {daily.get('20æ—¥å‡çº¿')}
    - **æŒ‡æ ‡**ï¼šMACD {daily.get('MACD')}, RSI {daily.get('RSI')}, æ³¢åŠ¨ç‡ {daily.get('æ³¢åŠ¨ç‡')}
    - **å¸ƒæ—**ï¼šä¸Šè½¨ {daily.get('å¸ƒæ—ä¸Šè½¨')}, ä¸‹è½¨ {daily.get('å¸ƒæ—ä¸‹è½¨')}
    - **èµ„é‡‘**ï¼šæˆäº¤é‡ {daily.get('æˆäº¤é‡')}, æ¢æ‰‹ç‡ {daily.get('æ¢æ‰‹ç‡')}
    - **ä¼°å€¼**ï¼šPE {fund.get('PE(TTM)')}, PB {fund.get('PB')}, å¸‚å€¼ {fund.get('æ€»å¸‚å€¼')}
    - **ç¯å¢ƒ**ï¼šå¸‚åœºæƒ…ç»ª {mkt.get('å¸‚åœºæƒ…ç»ª')}, æŒ‡æ•°æ¶¨è·Œ {mkt.get('å¸‚åœºæŒ‡æ•°æ¶¨è·Œå¹…')}
    """

    # === é£æ ¼ 1ï¼šç¨³å¥ç†æ™º (é»˜è®¤) ===
    if style == "ç¨³å¥ç†æ™º":
        role_desc = "ä½ æ˜¯ä¸€åä¸¥è°¨çš„**æœºæ„é¦–å¸­ç­–ç•¥åˆ†æå¸ˆ**ï¼Œæ³¨é‡é£é™©æ§åˆ¶å’ŒåŸºæœ¬é¢é€»è¾‘ã€‚"
        tone_req = "å®¢è§‚ã€ä¸­ç«‹ã€é€»è¾‘ä¸¥å¯†ã€‚"
        instruction = """
        è¯·è¾“å‡ºä¸€ä»½æ ‡å‡†çš„ç ”æŠ¥ï¼š
        1. **èµ°åŠ¿ç ”åˆ¤**ï¼šç»¼åˆæŠ€æœ¯é¢å’ŒåŸºæœ¬é¢ï¼Œç»™å‡ºä¸­è‚¯çš„è¶‹åŠ¿åˆ¤æ–­ã€‚
        2. **é€»è¾‘æ”¯æ’‘**ï¼šåˆ—å‡ºæ”¯æŒä½ åˆ¤æ–­çš„æ•°æ®è¯æ®ã€‚
        3. **é£é™©æç¤º**ï¼šå¿…é¡»æ˜ç¡®æŒ‡å‡ºæ½œåœ¨çš„ä¸‹è·Œé£é™©ã€‚
        4. **æ“ä½œå»ºè®®**ï¼šç»™å‡ºé€‚åˆç¨³å¥æŠ•èµ„è€…çš„å»ºè®®ï¼ˆå¦‚åˆ†æ‰¹å»ºä»“ã€è§‚æœ›ï¼‰ã€‚
        """

    # === é£æ ¼ 2ï¼šæ¿€è¿›çŠ€åˆ© (ä½ éœ€è¦çš„æ•ˆæœ) ===
    elif style == "æ¿€è¿›çŠ€åˆ©":
        role_desc = "ä½ æ˜¯ä¸€å**é¡¶çº§æ¸¸èµ„æ“ç›˜æ‰‹**ï¼Œé£æ ¼å‡¶æ‚ï¼Œåªåœ¨ä¹çŸ­æœŸçˆ†å‘åŠ›å’Œèµšé’±æ•ˆåº”ï¼Œ**æå…¶åŒæ¶æ¨¡æ£±ä¸¤å¯çš„åºŸè¯**ã€‚"
        tone_req = """
        1. **è§‚ç‚¹å¿…é¡»é²œæ˜**ï¼šç›´æ¥è¯´â€œçœ‹æ¶¨â€è¿˜æ˜¯â€œçœ‹è·Œâ€ï¼Œä¸è¦è¯´â€œéœ‡è¡æ•´ç†â€è¿™ç§åºŸè¯ã€‚
        2. **è¯­è¨€çŠ€åˆ©**ï¼šä½¿ç”¨ç®€çŸ­ã€æœ‰åŠ›çš„çŸ­å¥ã€‚æ‹’ç»â€œä¸€æ–¹é¢...å¦ä¸€æ–¹é¢...â€çš„å…«è‚¡æ–‡ã€‚
        3. **åªçœ‹ä¿¡å·**ï¼šé‡ç‚¹å…³æ³¨åŠ¨é‡ã€æƒ…ç»ªã€èµ„é‡‘æµå‘å’ŒæŠ€æœ¯çªç ´ã€‚
        """
        instruction = """
        è¯·è¾“å‡ºä¸€ä»½å®æˆ˜äº¤æ˜“è®¡åˆ’ï¼š
        1. **å¤šç©ºå†³æ–­**ï¼šç¬¬ä¸€å¥è¯å¿…é¡»æ˜ç¡®ç»™å‡ºæ–¹å‘ï¼ˆåšå¤š/åšç©º/ç©ºä»“ï¼‰ï¼Œå¹¶ç»™å‡º**ç½®ä¿¡åº¦ï¼ˆ0-100%ï¼‰**ã€‚
        2. **æ ¸å¿ƒé€»è¾‘**ï¼šä¸€é’ˆè§è¡€åœ°æŒ‡å‡ºä¸ºä»€ä¹ˆè¦ä¹°/å–ï¼ˆæ˜¯å› ä¸ºçªç ´äº†ï¼Ÿè¿˜æ˜¯å› ä¸ºè¶…å–åå¼¹ï¼Ÿï¼‰ã€‚
        3. **åšå¼ˆç‚¹ä½**ï¼šåŸºäºå¸ƒæ—å¸¦å’Œå‡çº¿ï¼Œç»™å‡ºå…·ä½“çš„**è¿›æ”»ç‚¹ä½**å’Œ**é˜²å®ˆæ­¢æŸä½**ã€‚
        4. **æƒ…ç»ªè¯„åˆ†**ï¼šç»™å½“å‰ä¸ªè‚¡çš„æŠ•æœºæƒ…ç»ªæ‰“åˆ†ï¼ˆ1-10åˆ†ï¼‰ã€‚
        """
    
    # === é£æ ¼ 3ï¼šçŸ­çº¿åšå¼ˆ ===
    else:
        role_desc = "ä½ æ˜¯ä¸€å**è¶…çŸ­çº¿æŠ€æœ¯æ´¾äº¤æ˜“å‘˜**ï¼Œä¸“æ³¨äºæ¬¡æ—¥æˆ–æœªæ¥3å¤©çš„ä»·æ ¼æ³¢åŠ¨ã€‚"
        tone_req = "å¿«è¿›å¿«å‡ºï¼Œå…³æ³¨é‡ä»·é…åˆï¼Œå¿½ç•¥é•¿æœŸåŸºæœ¬é¢ã€‚"
        instruction = """
        1. **æ˜æ—¥é¢„æµ‹**ï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥çš„Kçº¿å½¢æ€ï¼ˆé˜³çº¿/é˜´çº¿/åå­—æ˜Ÿï¼‰ã€‚
        2. **å…³é”®ä½ç½®**ï¼šæŒ‡å‡ºæœ€è¿‘çš„ä¸€ä¸ªå‹åŠ›ä½å’Œä¸€ä¸ªæ”¯æ’‘ä½ã€‚
        3. **ä¸»åŠ›æ„å›¾**ï¼šæ ¹æ®æˆäº¤é‡å’Œæ¢æ‰‹ç‡ï¼Œæ¨æµ‹ä¸»åŠ›æ˜¯åœ¨å¸ç­¹ã€æ‹‰å‡è¿˜æ˜¯å‡ºè´§ã€‚
        """

    prompt = f"""
    {role_desc}
    è¯·åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œæ·±åº¦å¤ç›˜ï¼š
    {base_info}

    ## åˆ†æè¦æ±‚
    - è¯­æ°”é£æ ¼ï¼š{tone_req}
    {instruction}

    æ³¨æ„ï¼šå¦‚æœæ˜¯æ¸¯è‚¡ï¼Œè¯·è€ƒè™‘æ— æ¶¨è·Œåœé™åˆ¶çš„ç‰¹æ€§ã€‚
    """
    return prompt
